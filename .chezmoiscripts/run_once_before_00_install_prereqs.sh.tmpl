#!/bin/sh
set -eu

{{ if eq .chezmoi.os "linux" -}}
# Debian/Ubuntuベースのシステム向け
if command -v apt-get >/dev/null; then
  echo "Debian/Ubuntu向けの前提条件をインストールします..."
  # sudo権限が必要な操作。sudo不要の環境では、これらのツールが事前にインストールされていることを前提とする。
  if command -v sudo >/dev/null; then
    sudo apt-get update
    sudo apt-get install -y build-essential file bison conky-all libncurses-dev
  else
    echo "sudoが見つかりません。前提条件がインストール済みであることを確認してください。"
  fi
fi

# Arch Linux向け
if command -v pacman >/dev/null; then
  echo "Arch Linux向けの前提条件を確認します..."
  if command -v sudo >/dev/null; then
    missing_pkgs=""
    for pkg in \
      alacritty \
      curl \
      conky \
      fcitx5 \
      fcitx5-configtool \
      fcitx5-gtk \
      fcitx5-mozc \
      fcitx5-qt \
      feh \
      fish \
      fontconfig \
      flameshot \
      git \
      i3-wm \
      i3lock \
      blueman \
      libarchive \
      network-manager-applet \
      picom \
      polybar \
      procps-ng \
      psmisc \
      pulseaudio \
      rofi \
      unzip \
      xclip \
      xorg-server \
      xorg-xbacklight \
      xorg-xinit \
      xss-lock; do
      if ! pacman -Qq "$pkg" >/dev/null 2>&1; then
        missing_pkgs="$missing_pkgs $pkg"
      fi
    done

    if [ -n "$missing_pkgs" ]; then
      echo "不足パッケージ:${missing_pkgs# }"
      sudo pacman -Syu --noconfirm --needed $missing_pkgs
    else
      echo "Arch Linuxの前提条件は既にインストール済みです。"
    fi
  else
    echo "sudoが見つかりません。前提条件がインストール済みであることを確認してください。"
  fi
fi

# Gentoo向け
# fcitx-mozc は後回し
# kernel config を変更することを忘れない
if command -v emerge >/dev/null; then
  echo "Gentoo向けの前提条件を確認します..."
  if command -v sudo >/dev/null; then
    missing_pkgs=""
    for pkg in \
      app-arch/libarchive \
      app-arch/unzip \
      app-i18n/fcitx \
      app-i18n/fcitx-configtool \
      app-i18n/fcitx-gtk \
      app-i18n/fcitx-qt \
      app-i18n/mozc \
      app-shells/fish \
      dev-vcs/git \
      gnome-extra/nm-applet \
      media-gfx/feh \
      media-gfx/flameshot \
      media-libs/fontconfig \
      net-misc/curl \
      app-admin/conky \
      sys-process/procps \
      sys-process/psmisc \
      x11-apps/xbacklight \
      x11-apps/xinit \
      x11-base/xorg-server \
      x11-misc/i3lock \
      x11-misc/picom \
      x11-misc/polybar \
      x11-misc/rofi \
      x11-misc/xclip \
      x11-misc/xss-lock \
      x11-terms/alacritty \
      x11-wm/i3; do
      if ! portageq has_version / "$pkg" >/dev/null 2>&1; then
        missing_pkgs="$missing_pkgs $pkg"
      fi
    done

    if [ -n "$missing_pkgs" ]; then
      echo "不足パッケージ:${missing_pkgs# }"
      sudo emerge --noreplace $missing_pkgs
    else
      echo "Gentooの前提条件は既にインストール済みです。"
    fi
  else
    echo "sudoが見つかりません。前提条件がインストール済みであることを確認してください。"
  fi
fi
{{ end -}}
