# dotfiles: 宣言的で再現可能な開発環境

[](https://chezmoi.io)
[](https://mise.jdx.dev)

## 📜 概要 (Overview)

このリポジトリは、私の個人的な開発環境をコードとして管理するためのものです。`chezmoi`と`mise`という2つの強力なツールを組み合わせることで、**宣言的 (Declarative)**、**再現可能 (Reproducible)**、そして\*\*移植可能 (Portable)\*\*な環境を構築することを目指しています。

新しいマシンを手に入れたとき、あるいは既存のマシンの環境を再構築したいときに、単一のコマンドを実行するだけで、使い慣れたツール、設定、シェル環境がすべて自動でセットアップされます。

## ✨ 設計思想 (Philosophy)

このdotfilesの核心は、明確な**責務の分離**に基づいています。

  * **`chezmoi` - 状態のオーケストレーター**: `chezmoi`は、ホームディレクトリ内のファイル、ディレクトリ、スクリプトの\*\*あるべき状態 (desired state)\*\*を管理します。設定ファイル（ドットファイル）のコンテンツやパーミッション、さらにはセットアップ時に一度だけ実行されるべきスクリプトまで、環境の静的な側面を定義します。
  * **`mise` - ツールのプロビジョナー**: `mise`は、開発ツール（言語ランタイム、CLIツールなど）の**利用可能性とバージョニング**を管理します。`mise`は、グローバルで必要なツールのバージョンを宣言的に定義し、それらを透過的に利用可能にします。

このリポジトリは単なる設定ファイルのバックアップではありません。環境全体をコードとして扱い、Gitを唯一の信頼できる情報源（Single Source of Truth）とすることで、設定のドリフト（意図しない差異）を防ぎ、常に一貫した環境を維持します。

## 🚀 クイックスタート (Quick Start)

### 前提条件 (Prerequisites)

  * `git`
  * `curl`
  * インターネット接続

### 新しいマシンでのセットアップ (New Machine Setup)

以下のワンライナーコマンドを実行するだけで、`chezmoi`がインストールされ、このリポジトリから設定が適用されます。

```sh
sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply peloeil
```

### 何が起こるか (What Happens)

上記のコマンドは、以下の処理を自動的に実行します。

1.  **`chezmoi`のインストール**: `get.chezmoi.io`スクリプトが、お使いのOSとアーキテクチャに適した`chezmoi`のバイナリをダウンロードし、インストールします。
2.  **リポジトリのクローン**: `chezmoi init`が、GitHub上のあなたのdotfilesリポジトリを`~/.local/share/chezmoi`にクローンします。
3.  **マシン固有の設定**:
      * リポジトリ内の`.chezmoi.toml.tmpl`テンプレートが実行されます。
      * Gitの`user.name`や`user.email`など、マシンごとに設定が必要な情報についてプロンプトが表示されます。
      * 入力された情報に基づいて、マシン固有の設定ファイル`~/.config/chezmoi/chezmoi.toml`が生成されます。
4.  **設定の適用 (`chezmoi apply`)**:
      * **`mise`のインストール**: `run_once_before_`プレフィックスを持つスクリプトが最初に実行されます。これにより、他の設定が適用される前に、ツール管理の要である`mise`がインストールされます。このスクリプトは冪等（何度実行しても同じ結果になる）に設計されており、`mise`が既に存在する場合は何も行いません。
      * **ドットファイルの展開**: `.zshrc.tmpl`や`.gitconfig.tmpl`などのテンプレートファイルが、`chezmoi.toml`のデータやシステム情報に基づいて展開され、ホームディレクトリの適切な場所に配置されます。
      * **シェルとの統合**: シェル設定ファイル（例: `~/.zshrc`）に`mise activate`コマンドが書き込まれます。これにより、シェル起動時に`mise`が有効になります。
5.  **ツールの自動インストール**:
      * 新しいシェルセッションを開始すると、`.zshrc`に書き込まれた`mise activate`が実行されます。
      * `mise`はグローバル設定ファイル（`~/.config/mise/config.toml`）を読み込み、そこにリストされているすべてのツール（Node.js, Python, Goなど）の指定されたバージョンのインストールを自動的に開始します。

このプロセスが完了すると、数分で完全にセットアップされた、すぐに開発を開始できる環境が手に入ります。

## 🏗️ アーキテクチャ (Architecture)

### リポジトリ構造 (Repository Structure)

このリポジトリは、`chezmoi`の規約とベストプラクティスに従って構成されています。

| パス | 説明 |
| :--- | :--- |
| `/.chezmoi.toml.tmpl` | `chezmoi init`時にマシン固有の設定ファイル（`~/.config/chezmoi/chezmoi.toml`）を生成するためのテンプレート。 |
| `/.chezmoiscripts/` | `mise`のインストールなど、命令的なロジックを実行するスクリプトを格納します。`run_once_`や`run_onchange_`といったプレフィックスで実行タイミングを制御します。 |
| `/.chezmoitemplates/` | 複数の設定ファイルで共有される再利用可能なテンプレートスニペットを格納します。DRY原則を推進します。 |
| `/.chezmoidata/` | スクリプトやテンプレートから利用される宣言的なデータ（例: インストールするシステムパッケージのリスト）を格納します。 |
| `/dot_config/mise/config.toml.tmpl` | `mise`で管理するグローバルなツールリストを定義する設定ファイルのテンプレート。このファイルがツールチェーンの宣言的な定義の中心となります。 |
| `/private_dot_gitconfig.tmpl` | マシン固有のデータ（名前、メールアドレス）を含むGit設定のテンプレート。`private_`プレフィックスにより、ファイルパーミッションが`0600`に設定されます。 |
| `/dot_zshrc.tmpl` | `mise activate`の有効化コマンドを含む、Zsh設定ファイルのテンプレート。 |
| `/.chezmoiexternals/` | （オプション）Neovim設定など、別のGitリポジトリで管理されている設定を外部コンポーネントとして取り込むための定義ファイルを格納します。 |

## 🔧 日々の運用 (Daily Workflow)

環境構築後の日常的な操作は、シンプルで宣言的なワークフローに従います。

### 設定ファイルを変更する (Editing Configuration)

管理対象のファイル（例: `~/.zshrc`）を編集する最も簡単で安全な方法は、`chezmoi edit`コマンドを使用することです。

```sh
# 編集後に自動で変更を適用する
chezmoi edit --apply ~/.zshrc
```

このコマンドは、エディタで実際のソーステンプレートファイル（この場合は`dot_zshrc.tmpl`）を開きます。`--apply`フラグを付けると、ファイルを保存して閉じた直後に変更がホームディレクトリに適用されます。

あるいは、ソースディレクトリ内のファイルを直接編集し、`diff`で確認してから`apply`することもできます。

```sh
# 1. ソースディレクトリに移動
chezmoi cd

# 2. テンプレートファイルを直接編集
# (例: nvim dot_zshrc.tmpl)

# 3. 元のディレクトリに戻る
exit

# 4. 変更差分を確認
chezmoi diff

# 5. 変更を適用
chezmoi apply
```

### 新しいツールを追加する (Adding a New Tool)

`mise`で管理するツールを追加・削除・バージョン変更する場合は、グローバル設定ファイルを編集します。

```sh
# 1. miseのグローバル設定テンプレートを編集
chezmoi edit ~/.config/mise/config.toml

# 2. [tools]セクションに新しいツールを追加 (例: jq = "latest")
#    ファイルを保存してエディタを終了

# 3. 変更を適用
chezmoi apply
```

`chezmoi apply`を実行すると、`~/.config/mise/config.toml`が更新されます。次に新しいシェルを開くか、`mise install`を実行すると、`mise`が新しいツールを自動的にインストールします。

### 変更をコミット＆プッシュする (Committing & Pushing Changes)

変更をリポジトリに保存するには、標準的な`git`コマンドを使用します。`chezmoi cd`を使うと、ソースディレクトリで簡単にシェルを起動できます。

```sh
# 1. ソースディレクトリに移動
chezmoi cd

# 2. Gitで変更をコミット
git add.
git commit -m "feat: Add jq and update zsh settings"
git push

# 3. 元のディレクトリに戻る
exit
```

**ヒント**: `~/.config/chezmoi/chezmoi.toml`で`autoCommit`と`autoPush`を`true`に設定すると、`chezmoi apply`実行後に自動でコミットとプッシュが行われるようになります。

### 他のマシンと同期する (Syncing with Other Machines)

他のマシンでリモートリポジトリの最新の変更を取り込んで適用するには、`chezmoi update`コマンドを実行します。

```sh
chezmoi update
```

このコマンドは、内部で`git pull`を実行してソースディレクトリを更新し、その後`chezmoi apply`を実行して変更をシステムに適用します。

## 🔍 検証とトラブルシューティング (Verification & Troubleshooting)

システムの状態を確認し、問題を診断するための便利なコマンドが用意されています。

  * `chezmoi doctor`: `chezmoi`の一般的な設定ミスや問題をチェックします。
  * `chezmoi diff`: `chezmoi apply`を実行する前に、どのような変更が加えられるかを差分形式で表示します。
  * `mise doctor`: `mise`のインストールとシェル統合が正しく行われているかを確認します。
  * `mise ls`: 現在アクティブなツールとそのバージョン、そしてそれらがどの設定ファイルから読み込まれているかを表示します。

## 🔒 高度な設定 (Advanced Topics)

### シークレット管理 (Secret Management)

APIキーやトークンなどの機密情報は、平文でリポジトリに保存するべきではありません。`chezmoi`は1Password、Bitwarden、GPGなど、多くのパスワードマネージャーや暗号化ツールとのネイティブな統合をサポートしています。これらを活用することで、シークレットを安全に管理し、テンプレート内で動的に値を注入できます。詳細は公式ドキュメントを参照してください。

### 宣言的なシステムパッケージ管理 (Declarative System Package Management)

`apt`や`brew`などのシステムパッケージマネージャーによるパッケージインストールも、宣言的なアプローチに統合できます。`.chezmoidata/packages.toml`のようなファイルにインストールしたいパッケージのリストを宣言的に記述し、そのファイルが変更されたときにのみ実行される`run_onchange_`スクリプトを作成することで、システムの基本パッケージもコードとして管理できます。
